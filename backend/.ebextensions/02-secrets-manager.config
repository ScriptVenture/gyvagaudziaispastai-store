commands:
  01_load_secrets:
    command: |
      #!/bin/bash
      # Get database credentials
      DB_SECRET=$(aws secretsmanager get-secret-value --secret-id medusa/database/credentials --region us-east-1 --query SecretString --output text)
      DB_HOST=$(echo $DB_SECRET | jq -r .host)
      DB_USER=$(echo $DB_SECRET | jq -r .username)
      DB_PASS=$(echo $DB_SECRET | jq -r .password)
      DB_NAME=$(echo $DB_SECRET | jq -r .dbname)
      DB_PORT=$(echo $DB_SECRET | jq -r .port)
      
      # Get Redis connection
      REDIS_SECRET=$(aws secretsmanager get-secret-value --secret-id medusa/redis/connection --region us-east-1 --query SecretString --output text)
      REDIS_HOST=$(echo $REDIS_SECRET | jq -r .REDIS_HOST)
      REDIS_PORT=$(echo $REDIS_SECRET | jq -r .REDIS_PORT)
      
      # Get application secrets
      APP_SECRET=$(aws secretsmanager get-secret-value --secret-id medusa/application/secrets --region us-east-1 --query SecretString --output text)
      JWT_SECRET=$(echo $APP_SECRET | jq -r .JWT_SECRET)
      COOKIE_SECRET=$(echo $APP_SECRET | jq -r .COOKIE_SECRET)
      PAYSERA_PROJECT_ID=$(echo $APP_SECRET | jq -r .PAYSERA_PROJECT_ID)
      PAYSERA_SIGN_PASSWORD=$(echo $APP_SECRET | jq -r .PAYSERA_SIGN_PASSWORD)
      VENIPAK_API_KEY=$(echo $APP_SECRET | jq -r .VENIPAK_API_KEY)
      VENIPAK_USERNAME=$(echo $APP_SECRET | jq -r .VENIPAK_USERNAME)
      VENIPAK_PASSWORD=$(echo $APP_SECRET | jq -r .VENIPAK_PASSWORD)
      
      # Set environment variables
      /opt/elasticbeanstalk/bin/get-config environment | jq ". + {
        \"DATABASE_URL\": \"postgresql://$DB_USER:$DB_PASS@$DB_HOST:$DB_PORT/$DB_NAME\",
        \"REDIS_URL\": \"redis://$REDIS_HOST:$REDIS_PORT\",
        \"JWT_SECRET\": \"$JWT_SECRET\",
        \"COOKIE_SECRET\": \"$COOKIE_SECRET\",
        \"PAYSERA_PROJECT_ID\": \"$PAYSERA_PROJECT_ID\",
        \"PAYSERA_SIGN_PASSWORD\": \"$PAYSERA_SIGN_PASSWORD\",
        \"VENIPAK_API_KEY\": \"$VENIPAK_API_KEY\",
        \"VENIPAK_USERNAME\": \"$VENIPAK_USERNAME\",
        \"VENIPAK_PASSWORD\": \"$VENIPAK_PASSWORD\"
      }" > /opt/elasticbeanstalk/deployment/env
